{% load keyvalue %}

<div class="row g-0 mt-2 ps-3 pe-3 pt-2 pb-2 rounded" style="background-color:aliceblue">

    <div class="col-auto pe-2 my-auto">
        <button type="button" class="form-button btn mb-1" id="recordButton">
            <i class="bi bi-mic"></i>
        </button><br>
        <button type="button" class="form-button btn" id="recordButton">
            <i class="bi bi-three-dots"></i>
        </button>
    </div>

    <div class="col pt-2 pb-2 ps-0 mt-0">
        <textarea class="form-control border-0 p-3 instruction-input" name="{{element.name}}" id="instruction-text" rows="7"
            style="font-size: 0.9em;">{{data|keyvalue:element.name}}</textarea>
    </div>

    <!-- Show prompt -->
    <!--
    <div class="col-1 p-0 my-auto">
        <button type="button" class="btn btn-light btn-block" style="font-size:small" data-bs-toggle="modal"
            data-bs-target="#exampleModal" hx-post="{% url 'projects:get_prompt' project_id=1 %}"
            hx-target="#prompt_modal" hx-vals='{"prompt": "{{instruction.prompt}}"}'>
            P
        </button>
    </div>
    -->
</div>

<div id="prompt_modal">
    {% include 'projects/modal_prompt.html' %}
</div>

<script>
    navigator.mediaDevices.getUserMedia({ audio: true })
    .then(function (stream) {
      mediaRecorder = new MediaRecorder(stream);

      document.querySelector("#recordButton").onclick = function () {
        if (mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          document.querySelector("#recordButton").innerHTML = '<i class="bi bi-mic"></i>';
        } else {
          mediaRecorder.start();
          document.querySelector("#recordButton").innerHTML = '<i class="bi bi-stop-circle"></i>';
        }
      };

      mediaRecorder.ondataavailable = function (e) {
        chunks.push(e.data);
      };

      mediaRecorder.onstop = function (e) {
        const blob = new Blob(chunks, { 'type': 'audio/ogg; codecs=opus' });
        chunks = [];
        const audioURL = window.URL.createObjectURL(blob);
        //document.querySelector("#audioElement").src = audioURL;
        document.querySelector("#instruction-text").textContent = "Transcribing audio..."
        document.querySelector("#instruction-text").classList.add("text-muted");
        // Call the function to upload audio
        uploadAudio(blob);
      };
    });

  function uploadAudio(blob) {
    let fd = new FormData();
    fd.append('audio', blob, 'audio.ogg');

    $.ajax({
      type: 'POST',
      url: 'transcribe_audio/',
      data: fd,
      processData: false,
      contentType: false
    }).done(function (data) {
      document.querySelector("#instruction-text").classList.remove("text-muted");
      document.querySelector("#instruction-text").textContent = data.text;
    });
  }
</script>